# Template Heaven - Docker Compose Configuration
# This file provides a complete development and production environment

version: '3.8'

services:
  # Main Template Heaven API service
  templateheaven:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: templateheaven:latest
    container_name: templateheaven
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      - CACHE_DIR=/home/templateheaven/.templateheaven/cache
    volumes:
      # Mount cache directory for persistence
      - templateheaven_cache:/home/templateheaven/.templateheaven/cache
      # Mount config directory for custom configuration
      - templateheaven_config:/home/templateheaven/.templateheaven
      # Mount current directory for development (optional)
      - .:/app:ro
    ports:
      - "8000:8000"  # API service port
    networks:
      - templateheaven_network
    restart: unless-stopped
    command: ["uvicorn", "templateheaven.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    user: "1000:1000"  # Non-root user

  # Development service with hot reload
  templateheaven-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    image: templateheaven:dev
    container_name: templateheaven-dev
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=DEBUG
    volumes:
      # Mount source code for hot reload
      - .:/app
      - templateheaven_cache:/home/templateheaven/.templateheaven/cache
      - templateheaven_config:/home/templateheaven/.templateheaven
    ports:
      - "8000:8000"  # API service port
      - "5678:5678"  # Debug port
    networks:
      - templateheaven_network
    command: ["uvicorn", "templateheaven.api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    profiles:
      - dev

  # Testing service
  templateheaven-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    image: templateheaven:test
    container_name: templateheaven-test
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=DEBUG
      - PYTEST_CURRENT_TEST=true
    volumes:
      - .:/app
      - templateheaven_test_cache:/tmp/test_cache
    networks:
      - templateheaven_network
    command: ["python", "-m", "pytest", "tests/", "-v", "--cov=templateheaven"]
    profiles:
      - test

  # Security scanning service
  templateheaven-security:
    image: aquasec/trivy:latest
    container_name: templateheaven-security
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - templateheaven_security_reports:/reports
    networks:
      - templateheaven_network
    command: ["image", "--exit-code", "1", "--severity", "HIGH,CRITICAL", "--format", "json", "--output", "/reports/trivy-report.json", "templateheaven:latest"]
    profiles:
      - security

  # Code quality service
  templateheaven-quality:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    image: templateheaven:quality
    container_name: templateheaven-quality
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - .:/app
      - templateheaven_quality_reports:/reports
    networks:
      - templateheaven_network
    command: >
      sh -c "
        echo 'Running code quality checks...' &&
        black --check templateheaven tests &&
        isort --check-only templateheaven tests &&
        flake8 templateheaven tests &&
        mypy templateheaven &&
        bandit -r templateheaven/ &&
        echo 'All quality checks passed!' > /reports/quality-report.txt
      "
    profiles:
      - quality

# Networks
networks:
  templateheaven_network:
    driver: bridge
    name: templateheaven_network

# Volumes
volumes:
  templateheaven_cache:
    driver: local
    name: templateheaven_cache
  templateheaven_config:
    driver: local
    name: templateheaven_config
  templateheaven_test_cache:
    driver: local
    name: templateheaven_test_cache
  templateheaven_security_reports:
    driver: local
    name: templateheaven_security_reports
  templateheaven_quality_reports:
    driver: local
    name: templateheaven_quality_reports
